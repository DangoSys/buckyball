name: Buckyball CI
run-name: ${{ github.actor }} is running CI Test 🚀
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'

jobs:
  CI-Test:
    name: CI Test
    runs-on: cpu-server
    steps:
      - name: Print information
        run: |
          echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
          echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Pull from the repository
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          setproxy
          git fetch origin +refs/heads/*:refs/remotes/origin/* +refs/pull/*/head:refs/remotes/origin/pr/*
          git clean -fd
          git reset --hard ${{ github.sha }}

      - name: Build Workloads
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          setproxy
          bbdev workload --build

      - name: Build Verilator
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          bbdev verilator --clean
          bbdev verilator --verilog
          bbdev verilator --build '--jobs 16'

      - name: Smoke Test
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          bbdev sardine --run '--workload ctest'

      - run: echo "🍏 CI Test is ${{ job.status }}."

      # 如果检查失败，强制回退分支
      # - name: Revert Bad Commit
      #   if: failure()
      #   shell: zsh {0}
      #   run: |
      #     source ~/.zshrc
      #     buckyball_exec
      #     setproxy
      #     git reset --hard HEAD~1
      #     git push --force origin ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
