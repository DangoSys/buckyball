name: Buckyball CI (Push)
run-name: ${{ github.actor }} is running CI Test üöÄ
on:
  push:
    branches:
      - main

jobs:
  CI-Test:
    name: CI Test
    runs-on: cpu-server
    steps:
      - name: Print information
        run: |
          echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
          echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Pull from the repository
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          setproxy
          git fetch origin main
          git clean -fd
          git reset --hard ${{ github.sha }}

      - name: Build Workloads
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          rm -rf workflow/.motia || true
          bbdev workload --build

      - name: Build Verilator
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          rm -rf workflow/.motia || true
          bbdev verilator --clean
          rm -rf workflow/.motia || true
          bbdev verilator --verilog '--config sims.verilator.BuckyballToyVerilatorConfig'
          rm -rf workflow/.motia || true
          bbdev verilator --build '--jobs 16'

      - name: Smoke Test
        shell: zsh {0}
        run: |
          source ~/.zshrc
          buckyball_exec
          rm -rf workflow/.motia || true
          bbdev sardine --run '--workload ctest'

      - run: echo "üçè CI Test is ${{ job.status }}."

      # if check failed, revert the branch
      # - name: Revert Bad Commit
      #   if: failure()
      #   shell: zsh {0}
      #   run: |
      #     source ~/.zshrc
      #     buckyball_exec
      #     setproxy
      #     git reset --hard HEAD~1
      #     git push --force origin main
