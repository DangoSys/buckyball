# BuckyBall

![image](./img/buckyball.png)

BuckyBallæ˜¯ä¸€ä¸ªå…¨æ ˆå¼€æºNPU/DSAè®¾è®¡æ¡†æ¶ã€‚

## 1. ğŸ¤” Why BuckyBall


>â—BuckyBall å¹¶ä¸æ˜¯æŸä¸ªå…·ä½“çš„NPUè®¾è®¡ï¼Œè€Œæ˜¯ä¸€ä¸ªè®¾è®¡æ¡†æ¶ã€‚ä½ å¯ä»¥åœ¨exampleæ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°å„ç§NPUçš„è®¾è®¡æ¡ˆä¾‹





## 2. Architecture

### 2.1 ISA
#### 2.1.1 bb_mvin

**åŠŸèƒ½**: å°†æ•°æ®ä»ä¸»å†…å­˜åŠ è½½åˆ°scratchpadå†…å­˜

**func7**: `0010000` (24)

**æ ¼å¼**: `bb_mvin rs1, rs2`

**æ“ä½œæ•°**:

- `rs1`: ä¸»å†…å­˜åœ°å€
- `rs2[addrLen-1:0]`: scratchpadåœ°å€
- `rs2[2*addrLen-1:addrLen]`: è¡Œæ•°(iter) ä¸€å…±æœ‰å¤šå°‘è¡Œ
- `rs2[2*addrLen+9:2*addrLen]`: åˆ—æ•° æœ€åä¸€è¡Œæœ‰å¤šå°‘åˆ—ï¼ˆmaskï¼‰ï¼Œå…¶ä½™è¡Œå‡ä¸å¸¦å®½å¯¹é½

**æ“ä½œ**: å°†ä¸»å†…å­˜åœ°å€`rs1`å¤„çš„æ•°æ®åŠ è½½åˆ°scratchpadåœ°å€`rs2[addrLen-1:0]`ï¼Œæ‰§è¡Œ`rs2[2*addrLen+9:addrLen]`æ¬¡è¿­ä»£

rs1:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        mem_addr                                 â”‚
â”‚                    (memAddrLen bits)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    [memAddrLen-1:0]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

rs2:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        row(iter)                 â”‚                sp_addr                   â”‚
â”‚     (10 bits)                    â”‚            (spAddrLen bits)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [spAddrLen+9: spAddrLen]         â”‚            [spAddrLen-1:0]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



#### 2.1.2 bb_mvout

**åŠŸèƒ½**: å°†æ•°æ®ä»scratchpadå†…å­˜å­˜å‚¨åˆ°ä¸»å†…å­˜

**func7**: `0010001` 25

**æ ¼å¼**: `bb_mvout rs1, rs2`

**æ“ä½œæ•°**:

- `rs1`: ä¸»å†…å­˜åœ°å€
- `rs2[addrLen-1:0]`: scratchpadåœ°å€
- `rs2[2*addrLen+9:addrLen]`: æ¬å‡ºå»å¤šå°‘è¡Œï¼ˆè¿­ä»£æ¬¡æ•°ï¼‰

**æ“ä½œ**: å°†scratchpadåœ°å€`rs2[addrLen-1:0]`å¤„çš„æ•°æ®å­˜å‚¨åˆ°ä¸»å†…å­˜åœ°å€`rs1`ï¼Œæ‰§è¡Œ`rs2[2*addrLen+9:addrLen]`æ¬¡è¿­ä»£

rs1:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        mem_addr                                 â”‚
â”‚                    (memAddrLen bits)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    [memAddrLen-1:0]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

rs2:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        row(iter)                 â”‚                sp_addr                   â”‚
â”‚     (10 bits)                    â”‚            (spAddrLen bits)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   [spAddrLen+9: spAddrLen]       â”‚             [spAddrLen-1:0]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.1.3 bb_mul_warp16 - ä¹˜æ³•æŒ‡ä»¤

**åŠŸèƒ½**: æ‰§è¡Œ16-way warpçš„çŸ©é˜µä¹˜æ³•è¿ç®—

**func7**: `0100000` 32

**æ ¼å¼**: `bb_mul_warp16 rs1, rs2`

**æ“ä½œæ•°**:

- `rs1[spAddrLen-1:0]`: ç¬¬ä¸€ä¸ªæ“ä½œæ•°çš„scratchpadåœ°å€
- `rs1[2*spAddrLen-1:spAddrLen]`: ç¬¬äºŒä¸ªæ“ä½œæ•°çš„scratchpadåœ°å€
- `rs2[spAddrLen-1:0]`: ç»“æœå†™å›çš„scratchpadåœ°å€
- `rs2[spAddrLen+9:spAddrLen]`: è¿­ä»£æ¬¡æ•°

**æ“ä½œ**: ä»scratchpadè¯»å–ä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰§è¡ŒçŸ©é˜µä¹˜æ³•è¿ç®—ï¼Œå¹¶å°†ç»“æœå†™å›åˆ°æŒ‡å®šçš„scratchpadåœ°å€

rs1:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           op2_spaddr           â”‚          op1_spaddr          â”‚
â”‚       (spAddrLen bits)         â”‚      (spAddrLen bits)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [2*spAddrLen-1:spAddrLen]     â”‚ [spAddrLen-1:0]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

rs2:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         iter             â”‚    wr_spaddr                       â”‚
â”‚       (10 bits)          â”‚  (spAddrLen bits)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [spAddrLen+9:  spAddrLen]â”‚  [spAddrLen-1:0]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```







### 2.2 Ball åè®®

æ‰€æœ‰Ballå…·æœ‰ç›¸åŒçš„åŸºç¡€å±æ€§, å…·ä½“å±æ€§ä¼šéšç€ç‰ˆæœ¬æ›´æ–°å˜åŒ–

```

```



### 2.3 æ•°æ®é€šè·¯

![image](./img/dma1.png)
![image](./img/dma2.png)

çº¦å®šï¼š
1. æ‰€æœ‰EXæŒ‡ä»¤çš„op1å’Œop2ä¸èƒ½åŒæ—¶è®¿é—®åŒä¸€ä¸ªbank
2. æ‰€æœ‰æŒ‡ä»¤å¯¹scratchpadçš„è®¿é—®ä¸èƒ½è¶…å‡ºè¯¥bank
3. æ‰€æœ‰bankå‡ä¸ºå•ç«¯å£(åŒæ—¶å¯è¯»å¯å†™ï¼Œåº”è¯¥ä¸æ”¯æŒè¯»å†™åŒä¸€ä¸ªåœ°å€(æœªæµ‹è¯•))
4. ç›®å‰çš„bankåˆ’åˆ†ï¼Œscratchpadä¸º4ä¸ªbank(64KBx4)ï¼Œaccä¸º2ä¸ªbank(64KBx2)
5. accçš„ä¸¤ä¸ªbankæ˜¯å¼¹æ€§çš„ï¼Œå½“CPUéœ€è¦ä½¿ç”¨spadæ—¶ï¼Œä¼šæ“ä½œaccä¸­çš„bank2



### 2.4 æŒ‡ä»¤é€šè·¯
```
GlobalDecoder â†’ å…¨å±€RS(frontend/rs) â†’ BallDomain / MemDomain
                  â†“                       â†“           â†“
            å…¨å±€ROB                  BallDecoder  MemDecoder
        (åªçŸ¥é“ball/mem)               â†“           â†“
                                   å±€éƒ¨FIFO    å±€éƒ¨FIFO
                           (å¯¹åº”ballç©ºé—²åˆ™å‘é€)   (å¯¹åº”ballç©ºé—²åˆ™å‘é€)
```
