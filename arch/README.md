# BuckyBall

![image](./img/buckyball.png)

BuckyBall是一个全栈开源NPU/DSA设计框架。

## 1. 🤔 Why BuckyBall


>❗BuckyBall 并不是某个具体的NPU设计，而是一个设计框架。你可以在example文件夹下找到各种NPU的设计案例





## 2. Architecture

### 2.1 ISA
#### 2.1.1 bb_mvin

**功能**: 将数据从主内存加载到scratchpad内存

**func7**: `0010000` (24)

**格式**: `bb_mvin rs1, rs2`

**操作数**:

- `rs1`: 主内存地址
- `rs2[addrLen-1:0]`: scratchpad地址
- `rs2[2*addrLen-1:addrLen]`: 行数(iter) 一共有多少行
- `rs2[2*addrLen+9:2*addrLen]`: 列数 最后一行有多少列（mask），其余行均与带宽对齐

**操作**: 将主内存地址`rs1`处的数据加载到scratchpad地址`rs2[addrLen-1:0]`，执行`rs2[2*addrLen+9:addrLen]`次迭代

rs1:

```
┌─────────────────────────────────────────────────────────────────┐
│                        mem_addr                                 │
│                    (memAddrLen bits)                            │
├─────────────────────────────────────────────────────────────────┤
│                    [memAddrLen-1:0]                             │
└─────────────────────────────────────────────────────────────────┘
```

rs2:

```
┌──────────────────────────────────┬──────────────────────────────────────────┐
│        row(iter)                 │                sp_addr                   │
│     (10 bits)                    │            (spAddrLen bits)              │
├──────────────────────────────────┼──────────────────────────────────────────┤
│ [spAddrLen+9: spAddrLen]         │            [spAddrLen-1:0]               │
└──────────────────────────────────┴──────────────────────────────────────────┘
```



#### 2.1.2 bb_mvout

**功能**: 将数据从scratchpad内存存储到主内存

**func7**: `0010001` 25

**格式**: `bb_mvout rs1, rs2`

**操作数**:

- `rs1`: 主内存地址
- `rs2[addrLen-1:0]`: scratchpad地址
- `rs2[2*addrLen+9:addrLen]`: 搬出去多少行（迭代次数）

**操作**: 将scratchpad地址`rs2[addrLen-1:0]`处的数据存储到主内存地址`rs1`，执行`rs2[2*addrLen+9:addrLen]`次迭代

rs1:

```
┌─────────────────────────────────────────────────────────────────┐
│                        mem_addr                                 │
│                    (memAddrLen bits)                            │
├─────────────────────────────────────────────────────────────────┤
│                    [memAddrLen-1:0]                             │
└─────────────────────────────────────────────────────────────────┘
```

rs2:

```
┌──────────────────────────────────┬──────────────────────────────────────────┐
│        row(iter)                 │                sp_addr                   │
│     (10 bits)                    │            (spAddrLen bits)              │
├──────────────────────────────────┼──────────────────────────────────────────┤
│   [spAddrLen+9: spAddrLen]       │             [spAddrLen-1:0]              │
└──────────────────────────────────┴──────────────────────────────────────────┘
```

#### 2.1.3 bb_mul_warp16 - 乘法指令

**功能**: 执行16-way warp的矩阵乘法运算

**func7**: `0100000` 32

**格式**: `bb_mul_warp16 rs1, rs2`

**操作数**:

- `rs1[spAddrLen-1:0]`: 第一个操作数的scratchpad地址
- `rs1[2*spAddrLen-1:spAddrLen]`: 第二个操作数的scratchpad地址
- `rs2[spAddrLen-1:0]`: 结果写回的scratchpad地址
- `rs2[spAddrLen+9:spAddrLen]`: 迭代次数

**操作**: 从scratchpad读取两个操作数，执行矩阵乘法运算，并将结果写回到指定的scratchpad地址

rs1:

```
┌────────────────────────────────┬──────────────────────────────┐
│           op2_spaddr           │          op1_spaddr          │
│       (spAddrLen bits)         │      (spAddrLen bits)        │
├────────────────────────────────┼──────────────────────────────┤
│  [2*spAddrLen-1:spAddrLen]     │ [spAddrLen-1:0]              │
└────────────────────────────────┴──────────────────────────────┘
```

rs2:

```
┌──────────────────────────┌────────────────────────────────────┐
│         iter             │    wr_spaddr                       │
│       (10 bits)          │  (spAddrLen bits)                  │
├──────────────────────────├────────────────────────────────────┤
│ [spAddrLen+9:  spAddrLen]│  [spAddrLen-1:0]                   │
└──────────────────────────└────────────────────────────────────┘
```







### 2.2 Ball 协议

所有Ball具有相同的基础属性, 具体属性会随着版本更新变化

```

```



### 2.3 数据通路

![image](./img/dma1.png)
![image](./img/dma2.png)

约定：
1. 所有EX指令的op1和op2不能同时访问同一个bank
2. 所有指令对scratchpad的访问不能超出该bank
3. 所有bank均为单端口(同时可读可写，应该不支持读写同一个地址(未测试))
4. 目前的bank划分，scratchpad为4个bank(64KBx4)，acc为2个bank(64KBx2)
5. acc的两个bank是弹性的，当CPU需要使用spad时，会操作acc中的bank2



### 2.4 指令通路
```
GlobalDecoder → 全局RS(frontend/rs) → BallDomain / MemDomain
                  ↓                       ↓           ↓
            全局ROB                  BallDecoder  MemDecoder
        (只知道ball/mem)               ↓           ↓
                                   局部FIFO    局部FIFO
                           (对应ball空闲则发送)   (对应ball空闲则发送)
```
